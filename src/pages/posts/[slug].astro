---
// src/pages/posts/[slug].astro
// FINAL, BULLETPROOF VERSION — WORKS ON GITHUB ACTIONS, LOCAL, EVERYWHERE

import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { marked } from 'marked';

// getStaticPaths — runs at build time
export async function getStaticPaths() {
  // Define postsDir INSIDE the function — 100% safe
  const postsDir = path.join(process.cwd(), 'src', 'content', 'posts');

  // Safety: directory must exist
  if (!fs.existsSync(postsDir)) {
    console.warn(`[getStaticPaths] Posts directory not found: ${postsDir}`);
    return [];
  }

  try {
    const files = fs.readdirSync(postsDir);

    const validSlugs = files
      .filter(filename =>
        filename.endsWith('.md') &&
        !filename.startsWith('.') &&
        !filename.includes('.bak') &&
        !filename.includes('draft')
      )
      .map(filename => filename.replace(/\.md$/, ''));

    return validSlugs.map(slug => ({
      params: { slug },
    }));
  } catch (error) {
    console.error('[getStaticPaths] Failed to read posts:', error);
    return [];
  }
}

// Now safe: slug comes from getStaticPaths
const { slug } = Astro.params;

// Reconstruct postsDir — must be identical to getStaticPaths
const postsDir = path.join(process.cwd(), 'src', 'content', 'posts');
const filePath = path.join(postsDir, `${slug}.md`);

// Critical: file must exist
if (!fs.existsSync(filePath)) {
  throw new Error(`Post not found: ${slug}\nFile: ${filePath}`);
}

// Read and parse
const raw = fs.readFileSync(filePath, 'utf-8');
const { data, content } = matter(raw);
const html = marked(content);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{data.title ? `${data.title} | TilaBlog` : `${slug} | TilaBlog`}</title>
    <link rel="stylesheet" href="/styles/globals.css" />
  </head>
  <body>
    <main class="container">
      <article class="post-full">
        <header class="post-header">
          <h1>{data.title || slug}</h1>
          {data.date && (
            <time class="date" datetime={data.date}>
              {new Date(data.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
          )}
        </header>
        <div class="content" set:html={html}></div>
      </article>
    </main>
  </body>
</html>
