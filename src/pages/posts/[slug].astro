---
// src/pages/posts/[slug].astro
// FINAL VERSION — 100% working, no errors, production-ready

import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { marked } from 'marked';

// Define postsDir at the very top — BEFORE getStaticPaths
const postsDir = path.join(process.cwd(), 'src', 'content', 'posts');

// Generate static paths — runs at build time
export async function getStaticPaths() {
  // Safety: check if directory exists
  if (!fs.existsSync(postsDir)) {
    console.warn(`[getStaticPaths] Posts directory not found: ${postsDir}`);
    return [];
  }

  try {
    const files = fs.readdirSync(postsDir);

    // Filter only valid .md files
    const validSlugs = files
      .filter(filename => 
        filename.endsWith('.md') &&
        !filename.startsWith('.') &&      // Skip .DS_Store, .gitignore
        !filename.includes('.bak') &&     // Skip backup files
        !filename.includes('draft')       // Skip drafts
      )
      .map(filename => filename.replace(/\.md$/, ''));

    // Return paths
    return validSlugs.map(slug => ({
      params: { slug },
    }));
  } catch (error) {
    console.error('[getStaticPaths] Error reading posts directory:', error);
    return [];
  }
}

// Now safe: slug comes from getStaticPaths
const { slug } = Astro.params;

// Build full file path
const filePath = path.join(postsDir, `${slug}.md`);

// Safety check — should never fail if getStaticPaths is correct
if (!fs.existsSync(filePath)) {
  throw new Error(`Post not found: ${slug}\nExpected file: ${filePath}`);
}

// Read and parse markdown
const raw = fs.readFileSync(filePath, 'utf-8');
const { data, content } = matter(raw);
const html = marked(content);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{data.title ? `${data.title} | TilaBlog` : `${slug} | TilaBlog`}</title>
    <link rel="stylesheet" href="/styles/globals.css" />
  </head>
  <body>
    <main class="container">
      <article class="post-full">
        <header class="post-header">
          <h1>{data.title || slug}</h1>
          {data.date && (
            <p class="date">
              {new Date(data.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </p>
          )}
        </header>

        <div class="content" set:html={html}></div>
      </article>
    </main>
  </body>
</html>
