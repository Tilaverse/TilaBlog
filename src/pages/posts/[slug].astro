---
// src/pages/posts/[slug].astro
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { marked } from 'marked';

// Define posts directory once at the top (safe at build time)
const postsDir = path.join(process.cwd(), 'src', 'content', 'posts');

// Generate valid static paths — only real .md files
export async function getStaticPaths() {
  if (!fs.existsSync(postsDir)) {
    console.warn(`Warning: Posts directory not found: ${postsDir}`);
    return [];
  }

  const files = fs.readdirSync(postsDir);

  const validSlugs = files
    .filter(file => 
      file.endsWith('.md') &&           // Must be .md
      !file.startsWith('.') &&          // Skip hidden files (.DS_Store, .gitignore)
      !file.includes('.bak') &&         // Skip backups
      !file.includes('draft')           // Optional: skip drafts
    )
    .map(file => file.replace(/\.md$/, '')); // Remove .md

  return validSlugs.map(slug => ({
    params: { slug },
  }));
}

// Slug is now guaranteed to come from getStaticPaths
const { slug } = Astro.params;

// Construct file path directly — no search needed
const filePath = path.join(postsDir, `${slug}.md`);

// Safety: file must exist (should always be true)
if (!fs.existsSync(filePath)) {
  throw new Error(`Post not found: ${slug} (looked for ${filePath})`);
}

// Read and parse markdown
const raw = fs.readFileSync(filePath, 'utf-8');
const { data, content } = matter(raw);
const html = marked(content);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{data.title || slug}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles/globals.css" />
  </head>
  <body>
    <article class="post-full">
      <h1>{data.title || slug}</h1>
      <p class="date">
        {data.date 
          ? new Date(data.date).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })
          : ''
        }
      </p>
      <div class="content" set:html={html}></div>
    </article>
  </body>
</html>
